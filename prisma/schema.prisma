// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Enum for activation status
enum status {
  active
  inactive
}

// Enum for user roles
enum user_role {
  master
  admin
  user
}

// Main user model
model user {
  id                String    @id @default(cuid())
  name              String
  email             String    @unique
  password_hash     String
  role              user_role  @default(user)
  company_id        String?
  is_active         Boolean   @default(true)
  last_login        DateTime?
  allowed           Json?     // Permissões customizadas específicas do usuário
  created_at        DateTime  @default(now())
  updated_at        DateTime  @updatedAt
  
  // Relationships
  profile           profile?
  
  // Company relationship (if needed)
  company           company?  @relation(fields: [company_id], references: [id])
  
  // Questionnaire relationships
  questionnaire_responses questionnaire_response[]
  
  // Diagnostic relationships
  diagnostics diagnostic[]
  
  // Action Plans relationships
  action_plans action_plan[]
  assigned_tasks task[] @relation("assigned_tasks")
  
  // Gamification relationships
  user_achievements user_achievement[]
  user_progress     user_progress?
  
  // Notification relationships
  notifications_created notification[] @relation("NotificationCreator")
  
  // Audit and activity relationships
  activity_logs     user_activity_log[]
  login_history     login_history[]
  notifications     notification[]
  
  @@map("users")
}

// User profile model
model profile {
  id          String   @id @default(cuid())
  user_id     String   @unique
  first_name  String?
  last_name   String?
  birth_date  DateTime?
  avatar_url  String?
  bio         String?
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt
  
  // Relationships
  user        user             @relation(fields: [user_id], references: [id], onDelete: Cascade)
  addresses   profile_address[]
  emails      profile_email[]
  phones      profile_phone[]
  
  @@map("profiles")
}

// Profile addresses model
model profile_address {
  id           String   @id @default(cuid())
  profile_id   String
  street       String
  number       String?
  complement   String?
  neighborhood String
  city         String
  state        String
  zip_code     String
  country      String   @default("Brasil")
  is_primary   Boolean  @default(false)
  created_at   DateTime @default(now())
  updated_at   DateTime @updatedAt
  
  // Relationships
  profile      profile  @relation(fields: [profile_id], references: [id], onDelete: Cascade)
  
  @@map("profile_addresses")
}

// Profile emails model
model profile_email {
  id           String   @id @default(cuid())
  profile_id   String
  email        String
  is_primary   Boolean  @default(false)
  is_verified  Boolean  @default(false)
  created_at   DateTime @default(now())
  updated_at   DateTime @updatedAt
  
  // Relationships
  profile      profile  @relation(fields: [profile_id], references: [id], onDelete: Cascade)
  
  @@unique([profile_id, email])
  @@map("profile_emails")
}

// Profile phones model
model profile_phone {
  id           String   @id @default(cuid())
  profile_id   String
  phone        String
  type         String?  // mobile, home, work, etc.
  is_primary   Boolean  @default(false)
  is_verified  Boolean  @default(false)
  created_at   DateTime @default(now())
  updated_at   DateTime @updatedAt
  
  // Relationships
  profile      profile  @relation(fields: [profile_id], references: [id], onDelete: Cascade)
  
  @@map("profile_phones")
}

// Company model (for user relationships)
model company {
  id          String   @id @default(cuid())
  name        String
  cnpj        String?  @unique
  email       String?
  phone       String?
  website     String?
  is_active   Boolean  @default(true)
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt
  
  // Relationships
  users       user[]
  subscriptions subscription[]
  
  @@map("companies")
}


// System permissions model
model permission {
  id          String   @id @default(cuid())
  key         String   @unique
  name        String
  description String?
  category    String?
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt
  
  // Relationships
  role_permissions role_permission[]
  
  @@map("permission")
}


// Relationship model between roles and permissions
model role_permission {
  id            String     @id @default(cuid())
  role          user_role
  permission_id String
  created_at    DateTime   @default(now())
  
  // Relationships
  permission    permission @relation(fields: [permission_id], references: [id], onDelete: Cascade)
  
  @@unique([role, permission_id])
  @@map("role_permission")
}


// ==================== QUESTIONÁRIOS (COLETA DE DADOS) ====================

// Questionários - formulários para coleta de dados
model questionnaire {
  id             String   @id @default(cuid())
  title          String
  description    String?
  type           String   // 'stress', 'climate', 'burnout', etc.
  estimated_time Int      @default(15) // Tempo estimado em minutos
  is_active      Boolean  @default(true)
  created_by     String   // user_id do master/admin que criou
  created_at     DateTime @default(now())
  updated_at     DateTime @updatedAt
  
  // Relationships
  questions    questionnaire_question[]
  responses    questionnaire_response[]
  diagnostics  diagnostic[] // Diagnósticos gerados a partir deste questionário
  
  @@map("questionnaires")
}

// Perguntas dos questionários
model questionnaire_question {
  id             String   @id @default(cuid())
  questionnaire_id String
  question       String
  type           String   // 'scale', 'multiple_choice', 'text', 'yes_no'
  order          Int
  required       Boolean  @default(true) // Se a pergunta é obrigatória
  is_active      Boolean  @default(true)
  created_at     DateTime @default(now())
  updated_at     DateTime @updatedAt
  
  // Relationships
  questionnaire  questionnaire @relation(fields: [questionnaire_id], references: [id], onDelete: Cascade)
  options        questionnaire_option[]
  responses      questionnaire_response[]
  
  @@map("questionnaire_questions")
}

// Opções das perguntas
model questionnaire_option {
  id          String   @id @default(cuid())
  question_id String
  value       String
  label       String
  score       Int      @default(1) // Score da opção para cálculo
  order       Int
  created_at  DateTime @default(now())
  
  // Relationships
  question    questionnaire_question @relation(fields: [question_id], references: [id], onDelete: Cascade)
  
  @@map("questionnaire_options")
}

// Respostas dos usuários aos questionários
model questionnaire_response {
  id             String   @id @default(cuid())
  user_id        String
  questionnaire_id String
  question_id    String
  response       String
  score          Float?   // Score simples da resposta
  completed_at   DateTime @default(now())
  
  // Relationships
  user           user                   @relation(fields: [user_id], references: [id], onDelete: Cascade)
  questionnaire  questionnaire          @relation(fields: [questionnaire_id], references: [id], onDelete: Cascade)
  question       questionnaire_question @relation(fields: [question_id], references: [id], onDelete: Cascade)
  
  @@unique([user_id, questionnaire_id, question_id])
  @@map("questionnaire_responses")
}

// ==================== DIAGNÓSTICOS (ANÁLISE IA) ====================

// Diagnósticos - análises geradas pela IA a partir das respostas
model diagnostic {
  id             String   @id @default(cuid())
  user_id        String
  questionnaire_id String
  analysis_data  Json     // Dados da análise da IA
  insights       String[] // Insights principais
  recommendations String[] // Recomendações geradas
  areas_focus    String[] // Áreas de foco identificadas
  score_intelligent Float // Score inteligente calculado pela IA
  status         String   // 'processing', 'completed', 'failed'
  generated_at   DateTime @default(now())
  completed_at   DateTime?
  
  // Relationships
  user           user           @relation(fields: [user_id], references: [id], onDelete: Cascade)
  questionnaire  questionnaire  @relation(fields: [questionnaire_id], references: [id], onDelete: Cascade)
  action_plans   action_plan[]  // Relação inversa para action_plan
  
  @@map("diagnostics")
}

// ==================== ACTION PLANS ====================

// Action plans model
model action_plan {
  id              String    @id @default(cuid())
  user_id         String
  title           String
  description     String?
  category        String    // 'leadership', 'wellness', 'development', 'performance', 'career'
  status          String    @default("rascunho")  // rascunho, em_andamento, pausado, concluido, cancelado
  priority        String    @default("media")     // baixa, media, alta
  progress        Int       @default(0)           // 0-100
  start_date      DateTime?
  due_date        DateTime?
  created_at      DateTime  @default(now())
  updated_at      DateTime  @updatedAt
  
  // Relationships
  user            user      @relation(fields: [user_id], references: [id], onDelete: Cascade)
  diagnostic_id   String?
  diagnostic      diagnostic? @relation(fields: [diagnostic_id], references: [id])
  goals           goal[]
  
  @@map("action_plans")
  @@index([user_id])
  @@index([diagnostic_id])
}

// Goal model
model goal {
  id              String    @id @default(cuid())
  title           String
  description     String?
  status          String    @default("pendente")  // pendente, em_andamento, concluida, cancelada
  priority        String    @default("media")     // baixa, media, alta
  progress        Int       @default(0)           // 0-100
  start_date      DateTime?
  due_date        DateTime?
  created_at      DateTime  @default(now())
  updated_at      DateTime  @updatedAt
  
  // Relationships
  action_plan_id  String
  action_plan     action_plan @relation(fields: [action_plan_id], references: [id], onDelete: Cascade)
  tasks           task[]
  
  @@map("goals")
  @@index([action_plan_id])
}

// Task model
model task {
  id              String    @id @default(cuid())
  title           String
  description     String?
  status          String    @default("pendente")  // pendente, em_andamento, concluida, cancelada
  priority        String    @default("media")     // baixa, media, alta
  due_date        DateTime?
  completed_at    DateTime?
  created_at      DateTime  @default(now())
  updated_at      DateTime  @updatedAt
  
  // Relationships
  goal_id         String
  goal            goal      @relation(fields: [goal_id], references: [id], onDelete: Cascade)
  assigned_to_id  String?
  assigned_to     user?     @relation("assigned_tasks", fields: [assigned_to_id], references: [id])
  
  @@map("tasks")
  @@index([goal_id])
  @@index([assigned_to_id])
}

// ==================== GAMIFICATION ====================

// Achievements model
model achievement {
  id          String   @id @default(cuid())
  title       String
  description String
  category    String   // 'diagnostics', 'plans', 'time', etc.
  level       String   // 'bronze', 'silver', 'gold', 'diamond'
  xp_points   Int
  rarity      String   // 'common', 'rare', 'epic', 'legendary'
  is_global   Boolean  @default(false) // true for global achievements
  is_active   Boolean  @default(true)
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt
  
  // Relationships
  users       user_achievement[]
  
  @@map("achievements")
}

// User achievements model
model user_achievement {
  id            String     @id @default(cuid())
  user_id       String
  achievement_id String
  unlocked      Boolean    @default(false)
  unlocked_at   DateTime?
  created_at    DateTime   @default(now())
  
  // Relationships
  user          user       @relation(fields: [user_id], references: [id], onDelete: Cascade)
  achievement   achievement @relation(fields: [achievement_id], references: [id], onDelete: Cascade)
  
  @@unique([user_id, achievement_id])
  @@map("user_achievement")
}

// User progress model
model user_progress {
  id            String   @id @default(cuid())
  user_id       String   @unique
  level         Int      @default(1)
  current_xp    Int      @default(0)
  next_xp       Int      @default(1000)
  unlocked_achievements Int @default(0)
  created_at    DateTime @default(now())
  updated_at    DateTime @updatedAt
  
  // Relationships
  user          user     @relation(fields: [user_id], references: [id], onDelete: Cascade)
  
  @@map("user_progress")
}

// ==================== FINANCIAL SYSTEM ====================

// Subscription plans model
model subscription_plan {
  id          String   @id @default(cuid())
  name        String
  description String?
  value       Float
  cycle       String   // 'monthly', 'quarterly', 'yearly'
  max_users   Int?
  features    String[] // array of included features
  is_active   Boolean  @default(true)
  created_at  DateTime @default(now())
  updated_at  DateTime @updatedAt
  
  // Relationships
  subscriptions subscription[]
  
  @@map("subscription_plan")
}

// Company subscriptions model
model subscription {
  id                String   @id @default(cuid())
  company_id        String
  plan_id           String
  status            String   // 'active', 'suspended', 'cancelled', 'expired'
  start_date        DateTime
  end_date          DateTime
  next_billing      DateTime
  discount          Float    @default(0)
  final_value       Float
  notes             String?
  created_at        DateTime @default(now())
  updated_at        DateTime @updatedAt
  
  // Relationships
  company           company        @relation(fields: [company_id], references: [id], onDelete: Cascade)
  plan              subscription_plan @relation(fields: [plan_id], references: [id])
  transactions      transaction[]
  
  @@map("subscriptions")
}

// Financial transactions model
model transaction {
  id                String   @id @default(cuid())
  subscription_id   String?
  type              String   // 'revenue', 'expense', 'refund'
  category          String   // 'subscription', 'infrastructure', 'marketing', etc.
  description       String
  value             Float
  status            String   // 'pending', 'processing', 'approved', 'rejected'
  payment_method    String   // 'card', 'pix', 'boleto', 'transfer'
  reference         String
  notes             String?
  transaction_date  DateTime
  created_at        DateTime @default(now())
  updated_at        DateTime @updatedAt
  
  // Relationships
  subscription      subscription? @relation(fields: [subscription_id], references: [id])
  
  @@map("transactions")
}

// ==================== AUDIT AND ACTIVITY TRACKING ====================

// User activity logs - rastreia todas as ações dos usuários
model user_activity_log {
  id          String   @id @default(cuid())
  user_id     String
  action      String   // 'login', 'logout', 'create_diagnostic', 'update_profile', etc.
  entity_type String?  // 'diagnostic', 'action_plan', 'user', 'questionnaire', etc.
  entity_id   String?  // ID da entidade afetada
  details     Json?    // Detalhes adicionais da ação
  ip_address  String?  // IP do usuário
  user_agent  String?  // Browser/device info
  created_at  DateTime @default(now())
  
  // Relationships
  user        user     @relation(fields: [user_id], references: [id], onDelete: Cascade)
  
  @@map("user_activity_logs")
}

// Login history - histórico detalhado de logins
model login_history {
  id              String   @id @default(cuid())
  user_id         String
  login_at        DateTime @default(now())
  logout_at       DateTime?
  ip_address      String?
  user_agent      String?
  device_info     String?  // Mobile, Desktop, Tablet
  browser_info    String?  // Chrome, Firefox, Safari, etc.
  location        String?  // Cidade/País (se disponível)
  session_duration Int?    // Duração da sessão em minutos
  status          String   // 'success', 'failed', 'suspicious'
  failure_reason  String?  // Motivo da falha se status = 'failed'
  
  // Relationships
  user            user     @relation(fields: [user_id], references: [id], onDelete: Cascade)
  
  @@map("login_history")
}

// ==================== NOTIFICATIONS SYSTEM ====================

// Enum for notification types
enum notification_type {
  info
  warning
  error
  success
  security
}

// Enum for notification priority
enum notification_priority {
  low
  medium
  high
  urgent
}

// Notifications - sistema de notificações por role
model notification {
  id          String                @id @default(cuid())
  user_id     String?               // null = notificação global por role
  role        user_role?            // null = notificação específica para user_id
  created_by  String?               // ID do usuário que criou a notificação
  title       String
  message     String
  type        notification_type     @default(info)
  priority    notification_priority @default(medium)
  is_read     Boolean               @default(false)
  is_global   Boolean               @default(false) // true = para todos os usuários
  action_url  String?               // URL para ação da notificação
  metadata    Json?                 // Dados adicionais
  expires_at  DateTime?             // Data de expiração
  created_at  DateTime              @default(now())
  read_at     DateTime?             // Quando foi lida
  
  // Relationships
  user        user?                 @relation(fields: [user_id], references: [id], onDelete: Cascade)
  creator     user?                 @relation("NotificationCreator", fields: [created_by], references: [id], onDelete: SetNull)
  
  @@map("notifications")
}

// ==================== REPORTS AND METRICS ====================

// System metrics model
model metric {
  id          String   @id @default(cuid())
  name        String
  value       Float
  category    String   // 'user', 'company', 'system', 'financial'
  period      String   // 'daily', 'weekly', 'monthly', 'yearly'
  metric_date DateTime
  created_at  DateTime @default(now())
  
  @@map("metrics")
}

// Generated reports model
model report {
  id          String   @id @default(cuid())
  title       String
  type        String   // 'diagnostics', 'engagement', 'financial', 'global'
  start_date  DateTime
  end_date    DateTime
  data        Json     // report data in JSON
  file_url    String?  // generated file URL
  created_by  String   // user_id who generated
  created_at  DateTime @default(now())
  
  @@map("reports")
}

